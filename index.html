<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Open World Game Prototype</title>
<style>
html, body { margin:0; height:100%; overflow:hidden; background:#1e1e2f; }
body { font-family: system-ui, sans-serif; }
#ui { position:fixed; top:10px; left:10px; color:white; font-weight:bold; z-index:10; }
</style>
</head>
<body>
<div id="ui">WASD เดิน • Space กระโดด • E เก็บของ</div>
<script type="module">
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
import { PointerLockControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/PointerLockControls.js';

// Renderer & Scene
const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);

// Camera & Controls
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
const controls = new PointerLockControls(camera, document.body);
document.body.addEventListener('click', ()=>controls.lock());

// Light
const light = new THREE.DirectionalLight(0xffffff,1);
light.position.set(50,100,50);
scene.add(light);
scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 0.6));

// Terrain
const planeGeo = new THREE.PlaneGeometry(200,200,50,50);
planeGeo.rotateX(-Math.PI/2);
const positions = planeGeo.attributes.position;
for(let i=0;i<positions.count;i++){
  const x = positions.getX(i);
  const z = positions.getZ(i);
  positions.setY(i, Math.sin(x*0.1)*2 + Math.cos(z*0.1)*2);
}
planeGeo.computeVertexNormals();
const planeMat = new THREE.MeshStandardMaterial({color:0x228B22});
const terrain = new THREE.Mesh(planeGeo, planeMat);
terrain.receiveShadow = true;
scene.add(terrain);

// Player
const player = { pos:new THREE.Vector3(0,5,0), vel:new THREE.Vector3(), onGround:false, height:1.8 };

// Objects to interact
const items = new THREE.Group();
for(let i=0;i<20;i++){
  const cube = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshStandardMaterial({color:0xff6347}));
  cube.position.set((Math.random()-0.5)*100,0,(Math.random()-0.5)*100);
  cube.position.y = Math.sin(cube.position.x*0.1)*2 + Math.cos(cube.position.z*0.1)*2 + 0.5;
  items.add(cube);
}
scene.add(items);

// Physics & Input
const keys = {};
document.addEventListener('keydown', e=>keys[e.code]=true);
document.addEventListener('keyup', e=>keys[e.code]=false);

document.addEventListener('keydown', e=>{ if(e.code==='KeyE') interact(); });
function interact(){
  const ray = new THREE.Raycaster(camera.position, controls.getDirection(new THREE.Vector3()));
  const hits = ray.intersectObjects(items.children);
  if(hits[0] && hits[0].distance < 3){ hits[0].object.visible=false; }
}

function getHeight(x,z){ return Math.sin(x*0.1)*2 + Math.cos(z*0.1)*2; }

// Loop
const clock = new THREE.Clock();
function animate(){
  const dt = clock.getDelta();
  const speed = keys['ShiftLeft'] ? 10 : 5;
  const forward = (keys['KeyW']?1:0)-(keys['KeyS']?1:0);
  const strafe  = (keys['KeyD']?1:0)-(keys['KeyA']?1:0);
  const dir = new THREE.Vector3();
  controls.getDirection(dir);
  dir.y=0; dir.normalize();
  const right = new THREE.Vector3().crossVectors(dir,new THREE.Vector3(0,1,0)).negate();
  player.vel.x = dir.x*forward*speed + right.x*strafe*speed;
  player.vel.z = dir.z*forward*speed + right.z*strafe*speed;
  player.vel.y -= 9.8*dt;
  if(player.onGround && keys['Space']){ player.vel.y=5; }
  player.pos.addScaledVector(player.vel, dt);
  const groundY = getHeight(player.pos.x,player.pos.z)+player.height*0.5;
  if(player.pos.y<=groundY){ player.pos.y=groundY; player.vel.y=0; player.onGround=true; } else player.onGround=false;
  camera.position.copy(player.pos);
  renderer.render(scene,camera);
  requestAnimationFrame(animate);
}
animate();

window.addEventListener('resize', ()=>{
  camera.aspect=window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth,window.innerHeight);
});
</script>
</body>
</html>
